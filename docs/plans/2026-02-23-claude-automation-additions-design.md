# Claude Automation Additions Design

Date: 2026-02-23

## Summary

Add 5 new automations to the existing Claude Code configuration to fill identified gaps:
- 2 Hooks (TypeScript type check, auto-generated file guard)
- 2 Skills (db-debug, deploy-check)
- 1 Subagent (migration-reviewer)
- PostgreSQL MCP server (already added to `.claude.json`)

## Context

The project already has a mature automation setup:
- 4 hooks (format-on-edit, auto-test-on-edit, git-safety-check, sensitive-file-guard)
- 3 custom skills (create-migration, gen-test, new-endpoint)
- 7 subagents (api-documenter, build-integrity-verifier, etc.)
- 25+ plugins enabled

These additions address specific gaps identified during codebase analysis.

## Design Decisions

- **Approach**: Individual files (not integrated into existing hooks) — matches existing single-responsibility pattern
- **TypeCheck hook mode**: Info-only (exit 0 always) — avoids blocking mid-edit
- **db-debug DB access**: PostgreSQL MCP server (not psql commands)
- **migration-reviewer model**: haiku — pattern-match-centric review, low cost

---

## 1. Hook: TypeScript Type Check (PostToolUse)

**File**: `.claude/hooks/typecheck-on-edit.sh`

**Behavior**:
- Triggers after Write/Edit on `.ts`/`.tsx` files in `frontend/`
- Runs `npx tsc --noEmit --pretty` with 30s timeout
- Outputs type errors to stderr (informational only)
- Always exits 0 (never blocks)
- Leverages `incremental: true` in tsconfig.json for fast repeat checks

**settings.json**: Add to existing PostToolUse Write|Edit matcher:
```json
{ "type": "command", "command": ".claude/hooks/typecheck-on-edit.sh", "timeout": 30 }
```

**Pattern**: Same as format-on-edit.sh (read JSON from stdin, extract file_path, route by path pattern).

---

## 2. Hook: Auto-Generated File Guard (PreToolUse)

**File**: `.claude/hooks/auto-generated-file-guard.sh`

**Blocked files**:
- `package-lock.json` — auto-generated by `npm install`
- `gradlew`, `gradlew.bat` — Gradle Wrapper scripts
- `gradle/wrapper/*` — Gradle Wrapper config
- `frontend/tsconfig.tsbuildinfo` — TypeScript build cache
- `.next/*` — Next.js build output

**Behavior**:
- Same pattern as sensitive-file-guard.sh (read JSON, extract file_path, case match)
- Exit 2 + stderr message on blocked files
- Exit 0 for all other files

**settings.json**: Add to existing PreToolUse Write|Edit matcher:
```json
{ "type": "command", "command": ".claude/hooks/auto-generated-file-guard.sh", "timeout": 5 }
```

---

## 3. Skill: db-debug

**File**: `.claude/skills/db-debug/SKILL.md`

**Frontmatter**:
```yaml
name: db-debug
description: Event Sourcing event history and projection state debugger
disable-model-invocation: true
```

**Capabilities**:
1. Query `event_store` table for a specific aggregate ID (time-ordered)
2. Check projection consistency (event-derived state vs read model)
3. Verify aggregate version matches latest event sequence
4. Show recent events (when no aggregate ID specified)

**DB Access**: PostgreSQL MCP server (postgres-mcp)

**Workflow**:
1. Parse arguments (aggregate ID or type name)
2. Query event_store via PostgreSQL MCP
3. Format and display event timeline
4. Query related projection tables
5. Output consistency report

---

## 4. Skill: deploy-check

**File**: `.claude/skills/deploy-check/SKILL.md`

**Frontmatter**:
```yaml
name: deploy-check
description: Pre-deployment checklist runner for production releases
disable-model-invocation: true
```

**Checks**:
1. Flyway migration version continuity and naming convention
2. Backend build (`./gradlew build`)
3. Frontend build (`npm run build`)
4. All tests pass (backend + frontend)
5. Seed data coverage (`R__dev_seed_data.sql`)
6. Docker compose config validation
7. No uncommitted changes (`git status`)

**Output**: Pass/Fail per item + overall summary

---

## 5. Subagent: migration-reviewer

**File**: `.claude/agents/migration-reviewer.md`

**Frontmatter**:
```yaml
name: migration-reviewer
description: Review Flyway migrations for safety risks
tools: Read, Glob, Grep, Bash
model: haiku
color: orange
```

**Review Categories**:
1. **Irreversible changes**: DROP TABLE/COLUMN, ALTER TYPE
2. **Data loss risk**: TRUNCATE, DELETE, column removal without migration
3. **FK constraint integrity**: Missing FKs on `*_id` columns, reference validation
4. **Lock contention**: ALTER TABLE on large tables, CONCURRENTLY recommendation
5. **Event Sourcing schema**: event_store table changes, projection consistency
6. **Project conventions**: AGENTS.md rules (tenant_id FK, UUID PK, timestamps)

**Output format**: Same as security-reviewer.md (SEVERITY + Location + Description + Impact + Fix)

---

## Files to Create/Modify

| Action | File |
|--------|------|
| Create | `.claude/hooks/typecheck-on-edit.sh` |
| Create | `.claude/hooks/auto-generated-file-guard.sh` |
| Create | `.claude/skills/db-debug/SKILL.md` |
| Create | `.claude/skills/deploy-check/SKILL.md` |
| Create | `.claude/agents/migration-reviewer.md` |
| Modify | `.claude/settings.json` (add hooks to matchers) |
