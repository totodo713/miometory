openapi: 3.0.3
info:
  title: Miometry Password Reset API
  version: 1.0.0
  description: |
    API contract for password reset functionality in Miometry Entry System.
    Backend implementation: Spring Boot 3.5.9 + Kotlin 2.3.0
    Frontend implementation: Next.js 16.1.6 + TypeScript 5.x

servers:
  - url: http://localhost:8080/api/v1
    description: Local development server
  - url: https://api.miometry.example.com/api/v1
    description: Production server (TBD)

tags:
  - name: Authentication
    description: Password reset authentication endpoints

paths:
  /auth/password-reset/request:
    post:
      tags:
        - Authentication
      summary: Request password reset
      description: |
        Initiates password reset flow by sending an email with reset link.
        **Anti-enumeration protection**: Always returns 200 OK regardless of email existence.
        
        **Rate Limiting (Backend)**: Token bucket algorithm
        - RPS: 20 requests/second (configurable via `RATE_LIMIT_RPS`)
        - Burst: 50 requests (configurable via `RATE_LIMIT_BURST`)
        - Response: 429 Too Many Requests if exceeded
        
        **Rate Limiting (Frontend)**: Client-side sliding window
        - Max: 3 requests per 5 minutes
        - Storage: localStorage with cross-tab sync
        - Algorithm: Sliding window (removes oldest attempt after 5 minutes)
        
        **Security**:
        - CSRF protection via cookie-based token (SPA mode)
        - Session timeout: 30 minutes
        - Email sent contains token with 24-hour expiration
      operationId: passwordResetRequest
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordResetRequestCommand'
            examples:
              valid_request:
                summary: Valid email request
                value:
                  email: "user@example.com"
              invalid_format:
                summary: Invalid email format (will be rejected by validation)
                value:
                  email: "invalid-email"
      responses:
        '200':
          description: |
            Password reset request accepted.
            **Important**: Always returns this response regardless of email existence (anti-enumeration).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                message: "If the email exists, a password reset link has been sent."
        '400':
          description: Validation error (invalid email format)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation_failed:
                  summary: Email validation failed
                  value:
                    errorCode: "VALIDATION_FAILED"
                    message: "Request validation failed"
                    timestamp: "2026-02-15T10:30:00Z"
                    details:
                      path: "/api/v1/auth/password-reset/request"
                      fieldErrors:
                        email: "must be a well-formed email address"
                invalid_argument:
                  summary: Invalid argument (e.g., null email)
                  value:
                    errorCode: "INVALID_ARGUMENT"
                    message: "Email is required"
                    timestamp: "2026-02-15T10:30:00Z"
                    details:
                      path: "/api/v1/auth/password-reset/request"
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                errorCode: "RATE_LIMIT_EXCEEDED"
                message: "Too many requests. Please try again later."
                timestamp: "2026-02-15T10:30:00Z"
                details:
                  path: "/api/v1/auth/password-reset/request"
                  retryAfter: 60
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                errorCode: "INTERNAL_SERVER_ERROR"
                message: "An unexpected error occurred. Please contact support."
                timestamp: "2026-02-15T10:30:00Z"
                details:
                  path: "/api/v1/auth/password-reset/request"

  /auth/password-reset/confirm:
    post:
      tags:
        - Authentication
      summary: Confirm password reset
      description: |
        Completes password reset flow by validating token and setting new password.
        
        **Token Validation**:
        - Token must be valid (not expired, not already used)
        - Token expiration: 24 hours from request
        - Single-use only (token invalidated after successful reset)
        
        **Password Requirements (Backend)**:
        - Minimum 8 characters
        - Must contain at least 1 uppercase letter
        - Must contain at least 1 lowercase letter
        - Must contain at least 1 digit
        
        **Frontend Additional Validation**:
        - Password strength indicator (zxcvbn-ts, 3 levels: weak/medium/strong)
        - Confirmation field must match new password
        - Real-time feedback with debounce (300ms)
        
        **Security**:
        - Token stored in sessionStorage (removed from URL history)
        - CSRF protection via cookie-based token
        - Password never logged or exposed in client-side storage
      operationId: passwordResetConfirm
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordResetConfirmCommand'
            examples:
              valid_request:
                summary: Valid password reset confirmation
                value:
                  token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                  newPassword: "NewSecure123"
              weak_password:
                summary: Weak password (will be rejected by validation)
                value:
                  token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                  newPassword: "12345"
      responses:
        '200':
          description: Password reset successfully completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                message: "Password reset successfully. You may now log in with your new password."
        '400':
          description: Validation error (password requirements not met)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation_failed:
                  summary: Password validation failed
                  value:
                    errorCode: "VALIDATION_FAILED"
                    message: "Request validation failed"
                    timestamp: "2026-02-15T10:30:00Z"
                    details:
                      path: "/api/v1/auth/password-reset/confirm"
                      fieldErrors:
                        newPassword: "Password must be at least 8 characters"
                invalid_request_body:
                  summary: Invalid JSON format
                  value:
                    errorCode: "INVALID_REQUEST_BODY"
                    message: "Invalid request body"
                    timestamp: "2026-02-15T10:30:00Z"
                    details:
                      path: "/api/v1/auth/password-reset/confirm"
        '404':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                errorCode: "INVALID_TOKEN"
                message: "Invalid or expired password reset token"
                timestamp: "2026-02-15T10:30:00Z"
                details:
                  path: "/api/v1/auth/password-reset/confirm"
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                errorCode: "RATE_LIMIT_EXCEEDED"
                message: "Too many requests. Please try again later."
                timestamp: "2026-02-15T10:30:00Z"
                details:
                  path: "/api/v1/auth/password-reset/confirm"
                  retryAfter: 60
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                errorCode: "INTERNAL_SERVER_ERROR"
                message: "An unexpected error occurred. Please contact support."
                timestamp: "2026-02-15T10:30:00Z"
                details:
                  path: "/api/v1/auth/password-reset/confirm"

components:
  schemas:
    PasswordResetRequestCommand:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: User's email address (RFC 5322 format)
          example: "user@example.com"
          pattern: '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'
      description: Request payload for initiating password reset

    PasswordResetConfirmCommand:
      type: object
      required:
        - token
        - newPassword
      properties:
        token:
          type: string
          description: Password reset token from email link (extracted from URL query parameter)
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
          minLength: 1
        newPassword:
          type: string
          format: password
          description: |
            New password meeting requirements:
            - Minimum 8 characters
            - At least 1 uppercase letter
            - At least 1 lowercase letter
            - At least 1 digit
          example: "NewSecure123"
          minLength: 8
      description: Request payload for confirming password reset

    MessageResponse:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: Human-readable success message
          example: "Password reset successfully. You may now log in with your new password."
      description: Standard success response format

    ErrorResponse:
      type: object
      required:
        - errorCode
        - message
        - timestamp
      properties:
        errorCode:
          type: string
          description: Machine-readable error code
          example: "INVALID_TOKEN"
          enum:
            - VALIDATION_FAILED
            - INVALID_ARGUMENT
            - INVALID_REQUEST_BODY
            - INVALID_TOKEN
            - RATE_LIMIT_EXCEEDED
            - INTERNAL_SERVER_ERROR
        message:
          type: string
          description: Human-readable error message
          example: "Invalid or expired password reset token"
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp when error occurred
          example: "2026-02-15T10:30:00Z"
        details:
          type: object
          description: Additional error context (optional)
          additionalProperties: true
          properties:
            path:
              type: string
              description: Request path where error occurred
              example: "/api/v1/auth/password-reset/confirm"
            fieldErrors:
              type: object
              description: Field-level validation errors (for 400 responses)
              additionalProperties:
                type: string
              example:
                newPassword: "Password must be at least 8 characters"
            retryAfter:
              type: integer
              description: Seconds until retry is allowed (for 429 responses)
              example: 60
      description: |
        Standard error response format for all API exceptions.
        Backend implementation: `com.worklog.api.ErrorResponse` (record)
        Global exception handler: `com.worklog.api.GlobalExceptionHandler`

  securitySchemes:
    CsrfToken:
      type: apiKey
      in: header
      name: X-XSRF-TOKEN
      description: |
        CSRF token for state-changing requests (POST, PUT, DELETE).
        Frontend must read token from `XSRF-TOKEN` cookie and send in request header.
        Backend validates via `CookieCsrfTokenRepository` (Spring Security).

security:
  - CsrfToken: []
