# Implementation Plan: Work-Log Entry System

**Branch**: `002-work-log-entry` | **Date**: 2026-01-02 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-work-log-entry/spec.md`

**Note**: This file is generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

This feature implements a comprehensive time-tracking system enabling engineers to record daily work hours across multiple projects, manage absences, submit monthly time entries for approval, and perform bulk data operations. The system integrates with organizational SSO/SAML/OAuth2 for authentication, enforces a hierarchical approval workflow, and maintains a complete audit trail through event sourcing. Key capabilities include: fine-grained time entry (15-minute increments), multi-project allocation per day, fiscal month period support, manager proxy entry, CSV import/export with streaming processing, and 7-year data retention for compliance.

Technical approach: Extend the existing DDD + Event Sourcing architecture with new domain aggregates (WorkLogEntry, Absence, ApprovalWorkflow), implement streaming CSV processing with progress feedback, add SSO/SAML/OAuth2 integration layer, implement auto-save with 60-second intervals on frontend, and create responsive calendar UI with Next.js 16 + React 19.

## Technical Context

**Language/Version**: 
- Backend: Kotlin 2.3.0, Java 21
- Frontend: TypeScript 5.x

**Primary Dependencies**: 
- Backend: Spring Boot 3.5.9, Spring Data JDBC, Spring Security, Flyway, Jackson
- Frontend: Next.js 16.1.1, React 19.2.3, Tailwind CSS 4.x

**Storage**: PostgreSQL with JSONB for event sourcing, event store for domain events, projection tables for read models

**Testing**: 
- Backend: JUnit 5, Spring Boot Test, Testcontainers, Database Rider
- Frontend: NEEDS CLARIFICATION (Jest/Vitest/Playwright to be determined)

**Target Platform**: 
- Backend: Linux server (Docker containerized)
- Frontend: Modern web browsers (Chrome, Firefox, Safari, Edge - latest 2 versions)

**Project Type**: Web application (separate backend/frontend)

**Performance Goals**: 
- Calendar view loads in <1 second for 30 entries (SC-006)
- CSV import processes 100 rows/second (SC-005)
- 100 concurrent users without degradation (SC-007)
- Mobile time entry completes in <2 minutes (SC-008)
- Auto-save operates with 99.9% reliability (SC-011)

**Constraints**: 
- 30-minute session timeout for security (FR-030)
- 60-second auto-save interval (FR-029)
- 15-minute time increment granularity (FR-001)
- 24-hour daily maximum validation (FR-003)
- TLS/HTTPS required for all communications (FR-032)
- Database encryption at rest required (FR-033)

**Scale/Scope**: 
- Support 100+ concurrent users
- 7-year data retention (FR-028)
- Fiscal month boundaries (21st-20th pattern)
- Multi-tenant isolation per organization
- Responsive design (desktop/tablet/mobile) (FR-023)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Code Quality
- ✅ **Static Analysis**: Ktlint configured in build.gradle.kts, Biome configured for frontend
- ✅ **Peer Review**: All changes will go through PR review process
- ✅ **Documentation**: All public APIs will be documented with KDoc/JSDoc
- ✅ **Simplicity**: Following existing DDD patterns, no unnecessary abstraction layers

### II. Testing Discipline & Standards
- ✅ **Test Coverage**: Will create unit tests for domain logic, integration tests for APIs, contract tests for frontend-backend
- ✅ **Test Pyramid**: Unit (domain/services) > Integration (API/DB) > E2E (critical user flows)
- ✅ **No Merge Without Tests**: All PRs require passing tests
- ✅ **Fast & Isolated**: Unit tests run in-memory, integration tests use Testcontainers

### III. Consistent User Experience (UX)
- ✅ **Design System**: Will follow existing patterns, create reusable calendar components
- ✅ **Consistency**: Terms aligned with spec (Time Entry, Absence, Project, etc.)
- ✅ **Error Communication**: Clear validation messages, loading states, auto-save indicators (FR-031)
- ✅ **Accessibility**: Standard HTML controls, keyboard navigation, ARIA labels

### IV. Performance Requirements
- ✅ **Latency Targets**: Explicit targets defined in SC-006, SC-007, SC-008
- ✅ **Release Blocking**: Performance tests will be added to CI/CD
- ✅ **Automated Checks**: Will add performance benchmarks for CSV import and calendar rendering
- ✅ **Documented Tradeoffs**: Streaming CSV import chosen for scalability over simplicity

### Additional Constraints
- ✅ **Dependencies**: All dependencies are up-to-date and actively maintained (Spring Boot 3.5.9, Next.js 16.1.1)
- ✅ **Versioning**: Using explicit versions in build.gradle.kts and package.json
- ✅ **Reproducible**: Docker Compose for dev environment, Gradle wrapper for builds

### Development Workflow
- ✅ **Ticketing**: This feature has spec.md with 7 user stories, 33 functional requirements
- ✅ **Test Scenarios**: Acceptance scenarios documented for each user story
- ✅ **Quality Gates**: Constitution check completed, will verify at Phase 1 design review
- ✅ **CI/CD**: Existing GitHub Actions/GitLab CI to be extended with new tests

**Gate Status**: ✅ PASSED - No violations detected. All constitution principles are satisfied by the existing architecture and planned approach.

## Project Structure

### Documentation (this feature)

```text
specs/002-work-log-entry/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
│   └── openapi.yaml     # REST API contract
├── spec.md              # Feature specification (input)
├── proposal.md          # Original technical proposal (reference)
├── tasks.md             # Existing task breakdown (reference)
└── checklists/
    └── requirements.md  # Specification quality checklist
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── main/
│   │   ├── java/com/worklog/
│   │   │   ├── domain/
│   │   │   │   ├── worklog/             # NEW: WorkLog aggregate
│   │   │   │   │   ├── WorkLogEntry.java
│   │   │   │   │   ├── WorkLogEntryId.java
│   │   │   │   │   ├── TimeAmount.java
│   │   │   │   │   ├── WorkLogStatus.java
│   │   │   │   │   └── events/
│   │   │   │   ├── absence/             # NEW: Absence aggregate
│   │   │   │   │   ├── Absence.java
│   │   │   │   │   ├── AbsenceType.java
│   │   │   │   │   └── events/
│   │   │   │   ├── approval/            # NEW: Approval workflow aggregate
│   │   │   │   │   ├── MonthlyApproval.java
│   │   │   │   │   ├── ApprovalStatus.java
│   │   │   │   │   └── events/
│   │   │   │   ├── member/              # EXTEND: Add proxy entry permissions
│   │   │   │   ├── project/             # EXTEND: Add project assignment tracking
│   │   │   │   └── shared/              # EXTEND: Add DateRange, FiscalPeriod value objects
│   │   │   ├── application/
│   │   │   │   ├── service/
│   │   │   │   │   ├── WorkLogEntryService.java      # NEW
│   │   │   │   │   ├── AbsenceService.java           # NEW
│   │   │   │   │   ├── ApprovalService.java          # NEW
│   │   │   │   │   ├── CsvImportService.java         # NEW (streaming)
│   │   │   │   │   ├── CsvExportService.java         # NEW
│   │   │   │   │   └── ProxyEntryService.java        # NEW
│   │   │   │   └── command/
│   │   │   │       ├── CreateWorkLogEntryCommand.java    # NEW
│   │   │   │       ├── SubmitMonthForApprovalCommand.java # NEW
│   │   │   │       └── ApproveMonthCommand.java          # NEW
│   │   │   ├── infrastructure/
│   │   │   │   ├── repository/
│   │   │   │   │   ├── JdbcWorkLogRepository.java    # NEW
│   │   │   │   │   ├── JdbcAbsenceRepository.java    # NEW
│   │   │   │   │   └── JdbcApprovalRepository.java   # NEW
│   │   │   │   ├── projection/
│   │   │   │   │   ├── WorkLogProjection.java        # NEW (read model)
│   │   │   │   │   ├── MonthlyCalendarProjection.java # NEW
│   │   │   │   │   └── MonthlySummaryProjection.java  # NEW
│   │   │   │   ├── security/
│   │   │   │   │   ├── SsoAuthenticationProvider.java # NEW (SSO/SAML/OAuth2)
│   │   │   │   │   └── SessionTimeoutConfig.java     # NEW
│   │   │   │   └── csv/
│   │   │   │       ├── StreamingCsvProcessor.java    # NEW
│   │   │   │       └── CsvValidationService.java     # NEW
│   │   │   └── api/
│   │   │       ├── WorkLogController.java           # NEW
│   │   │       ├── AbsenceController.java           # NEW
│   │   │       ├── ApprovalController.java          # NEW
│   │   │       ├── CsvImportController.java         # NEW (streaming upload)
│   │   │       └── CalendarController.java          # NEW
│   │   ├── kotlin/com/worklog/
│   │   │   └── infrastructure/config/
│   │   │       └── SecurityConfig.kt                # EXTEND: Add SSO config
│   │   └── resources/
│   │       ├── db/migration/
│   │       │   ├── V4__work_log_entry_tables.sql    # NEW
│   │       │   ├── V5__absence_tables.sql           # NEW
│   │       │   └── V6__approval_workflow_tables.sql # NEW
│   │       └── application.yaml                     # EXTEND: Add SSO properties
│   └── test/
│       ├── java/com/worklog/
│       │   ├── domain/
│       │   │   ├── worklog/
│       │   │   │   ├── WorkLogEntryTest.java        # NEW
│       │   │   │   └── TimeAmountTest.java          # NEW
│       │   │   ├── absence/
│       │   │   │   └── AbsenceTest.java             # NEW
│       │   │   └── approval/
│       │   │       └── MonthlyApprovalTest.java     # NEW
│       │   └── application/
│       │       └── service/
│       │           ├── WorkLogEntryServiceTest.java # NEW
│       │           ├── CsvImportServiceTest.java    # NEW (streaming tests)
│       │           └── ApprovalServiceTest.java     # NEW
│       └── kotlin/com/worklog/
│           └── api/
│               ├── WorkLogControllerTest.kt         # NEW
│               ├── CsvImportControllerTest.kt       # NEW
│               └── ApprovalControllerTest.kt        # NEW

frontend/
├── app/
│   ├── worklog/                         # NEW: Time entry feature
│   │   ├── page.tsx                     # Calendar view
│   │   ├── [date]/
│   │   │   └── page.tsx                 # Daily entry form
│   │   ├── approval/
│   │   │   └── page.tsx                 # Manager approval view
│   │   └── import/
│   │       └── page.tsx                 # CSV import interface
│   ├── components/
│   │   ├── worklog/                     # NEW
│   │   │   ├── Calendar.tsx             # Monthly calendar component
│   │   │   ├── DailyEntryForm.tsx       # Time entry form
│   │   │   ├── ProjectSelector.tsx      # Multi-project allocation
│   │   │   ├── AbsenceForm.tsx          # Absence recording
│   │   │   ├── MonthlySummary.tsx       # Hours summary
│   │   │   ├── ApprovalPanel.tsx        # Manager approval UI
│   │   │   ├── CsvUploader.tsx          # Streaming upload with progress
│   │   │   └── AutoSaveIndicator.tsx    # Auto-save status (FR-031)
│   │   └── shared/
│   │       ├── LoadingSpinner.tsx       # EXTEND
│   │       └── ErrorBoundary.tsx        # EXTEND
│   ├── services/
│   │   ├── worklogApi.ts                # NEW: API client
│   │   ├── autoSaveService.ts           # NEW: 60-sec auto-save logic
│   │   ├── csvService.ts                # NEW: Streaming upload client
│   │   └── authService.ts               # EXTEND: SSO integration
│   ├── hooks/
│   │   ├── useAutoSave.ts               # NEW: Auto-save hook
│   │   ├── useSessionTimeout.ts         # NEW: 30-min timeout hook
│   │   └── useCalendarData.ts           # NEW: Calendar data fetching
│   └── types/
│       ├── worklog.ts                   # NEW: Type definitions
│       ├── absence.ts                   # NEW
│       └── approval.ts                  # NEW
└── tests/
    ├── unit/
    │   └── components/
    │       └── worklog/
    │           ├── Calendar.test.tsx    # NEW
    │           └── DailyEntryForm.test.tsx # NEW
    └── integration/
        └── worklog-flow.test.tsx        # NEW: E2E critical paths
```

**Structure Decision**: We are using the existing **Web application** structure (Option 2) with separate `backend/` (Spring Boot + Kotlin) and `frontend/` (Next.js + TypeScript) directories. This aligns with the current project layout and allows independent scaling of frontend and backend services. The backend follows DDD organization with domain aggregates in `domain/`, orchestration in `application/`, and infrastructure concerns in `infrastructure/` and `api/` layers. The frontend follows Next.js App Router conventions with feature-based organization under `app/worklog/`.

## Complexity Tracking

> **No violations detected - this section intentionally left blank**

All constitution gates passed without exceptions. The implementation follows existing architectural patterns (DDD + Event Sourcing) and introduces no new complexity beyond what is necessary for the feature requirements.

---

## Phase 0: Research & Technical Decisions

**Status**: ✅ COMPLETE

All unknowns from Technical Context have been resolved through research. See [research.md](./research.md) for detailed findings.

### Research Decisions Summary

1. **Frontend Testing Framework**: Vitest + React Testing Library + Playwright
2. **SSO Integration**: Spring Security OAuth2 Client + SAML2 (combination approach)
3. **Streaming CSV**: Apache Commons CSV + WebSocket progress reporting
4. **Auto-Save**: TanStack Query with optimistic updates + localStorage backup
5. **Database Encryption**: Filesystem-level (LUKS) for production, plaintext for dev
6. **Session Timeout**: Combined frontend idle detection + backend session management

---

## Phase 1: Design & Contracts

**Status**: ✅ COMPLETE

**Prerequisites**: 
- ✅ Constitution Check passed
- ✅ research.md complete

### Deliverables

1. ✅ **data-model.md**: Entity definitions, relationships, validation rules
   - WorkLogEntry aggregate (fields, events, invariants)
   - Absence aggregate
   - MonthlyApproval aggregate
   - Value objects (TimeAmount, FiscalPeriod, ApprovalStatus)
   - Projections (calendar view, monthly summary)

2. ✅ **contracts/openapi.yaml**: REST API contract
   - Endpoints derived from functional requirements
   - Request/response schemas
   - Authentication/authorization specifications
   - Error response formats

3. ✅ **quickstart.md**: Developer onboarding guide
   - Local development setup (Docker Compose)
   - Backend: Run Spring Boot with test data
   - Frontend: Run Next.js dev server
   - SSO mock configuration for local testing
   - Database migrations
   - Test execution commands

4. ✅ **Agent Context Update**: Run `.specify/scripts/bash/update-agent-context.sh opencode`
   - Add SSO/SAML/OAuth2 integration libraries
   - Add CSV streaming processing libraries
   - Add frontend testing framework (from research)
   - Preserve existing technology stack

### Design Tasks

1. ✅ **Domain Event Modeling**
   - WorkLogEntryCreated, WorkLogEntryUpdated, WorkLogEntryDeleted
   - MonthSubmittedForApproval, MonthApproved, MonthRejected
   - AbsenceRecorded, AbsenceUpdated

2. ✅ **Projection Design**
   - Calendar projection: date → total hours + status
   - Monthly summary projection: project → total hours + percentage
   - Approval queue projection: pending months per manager

3. ✅ **API Endpoint Design**
   - POST /api/worklog/entries (create/update time entry)
   - GET /api/worklog/calendar/{year}/{month} (calendar view)
   - POST /api/worklog/submissions (submit month for approval)
   - POST /api/worklog/approvals/{submissionId}/approve
   - POST /api/worklog/csv/import (streaming upload)
   - GET /api/worklog/csv/export/{year}/{month}

4. ✅ **Frontend Component Architecture**
   - Calendar component state management
   - Auto-save service with conflict resolution
   - Streaming CSV upload with progress bar
   - Session timeout warning dialog

### Constitution Re-evaluation

✅ **PASSED** - Phase 1 design reviewed against constitution principles:

**I. Code Quality**
- ✅ Data model follows DDD patterns with clear aggregate boundaries
- ✅ Value objects enforce invariants (TimeAmount, FiscalMonthPeriod)
- ✅ API contract is well-documented with OpenAPI 3.0.3
- ✅ No unnecessary complexity introduced

**II. Testing Discipline**
- ✅ Domain events enable comprehensive event-driven testing
- ✅ Projections (read models) are testable independently
- ✅ API endpoints have clear success/error response schemas
- ✅ Quickstart guide includes test execution commands

**III. Consistent UX**
- ✅ API responses have consistent error format (ErrorResponse)
- ✅ Validation errors provide field-level detail (ValidationErrorResponse)
- ✅ Conflict resolution strategy defined (optimistic locking with 409 Conflict)
- ✅ Loading states addressed (SSE for CSV progress, auto-save indicators)

**IV. Performance**
- ✅ Projections optimize read performance (denormalized read models)
- ✅ Event sourcing enables horizontal scaling
- ✅ CSV streaming prevents memory exhaustion (100K rows via UI)
- ✅ Optimistic locking minimizes database locks

**Additional Constraints**
- ✅ PostgreSQL JSONB for flexible event storage
- ✅ OAuth2/SAML2 authentication clearly specified
- ✅ Versioned API (v1) for future compatibility
- ✅ Docker Compose for reproducible dev environment

**Verdict**: No architectural violations detected. Design maintains existing DDD + Event Sourcing patterns and adheres to all constitution principles.

---

## Phase 2+: Task Breakdown

**Status**: ⏸️ READY (execute `/speckit.tasks` command)

Task decomposition, dependency mapping, and effort estimation will be performed by the `/speckit.tasks` command now that Phase 1 design is complete. Output will be written to `tasks.md`.

---

## Next Steps

1. ✅ **Complete**: Constitution Check passed
2. ✅ **Complete**: Phase 0 research (6 unknowns + 4 best practices resolved)
3. ✅ **Complete**: Phase 1 design (data model, contracts, quickstart, agent context updated)
4. ⏭️ **Next**: Phase 2 task breakdown (`/speckit.tasks` command)

**Current Action**: Phase 1 complete. Ready to proceed with `/speckit.tasks` for task decomposition.
