# Feature Specification: ユーザーログイン認証・認可システム

**Feature Branch**: `001-user-login-auth`  
**Created**: 2026-02-03  
**Status**: Draft  
**Input**: User description: "ユーザーのログインを作成したい。認証と認可を実装"

## Clarifications

### Session 2026-02-03

- Q: 未確認アカウントでのログイン試行時の振る舞い → A: ログインを許可するが、機能制限付きの状態でシステムにアクセスさせ、画面上部に「メール確認が必要です」というバナーを常時表示
- Q: パスワードリセットメール送信失敗時の振る舞い → A: ユーザーには「メールを送信しました。届かない場合は迷惑メールフォルダを確認するか、サポートにお問い合わせください」と表示し、内部的にエラーログに記録する
- Q: ロールに紐づく権限のレベル → A: 機能単位（例: ユーザー作成、ユーザー編集、ユーザー削除、レポート閲覧など）の細かい権限セット
- Q: 監査ログの保存期間 → A: 90日間
- Q: システム可用性の目標 → A: 99.5% (月間約3.6時間のダウンタイム許容)

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ユーザーアカウント作成とログイン (Priority: P1)

新規ユーザーがアカウントを作成し、そのアカウントでログインできる。

**Why this priority**: システムの最も基本的な機能であり、他のすべての認証・認可機能の基盤となる。この機能がなければユーザーはシステムを利用開始できない。

**Independent Test**: 新規ユーザー登録フォームから情報を入力し、アカウント作成後にログインできることで独立してテスト可能。ログイン成功後にユーザー専用のダッシュボードまたはホーム画面が表示される。

**Acceptance Scenarios**:

1. **Given** ユーザーが未登録である、**When** メールアドレス、パスワード、名前を入力してアカウント作成する、**Then** アカウントが作成され、確認メールが送信される
2. **Given** アカウントが作成済みである、**When** 正しいメールアドレスとパスワードでログインする、**Then** ログインに成功し、ユーザー専用画面に遷移する
3. **Given** 未確認状態のアカウントでログインする、**When** システムにアクセスする、**Then** 機能制限付きでアクセスでき、画面上部に「メール確認が必要です」というバナーが常時表示される
4. **Given** ログイン済みである、**When** ログアウトボタンをクリックする、**Then** ログアウトされ、ログイン画面に戻る
5. **Given** ログインフォームにアクセスしている、**When** 間違ったパスワードを入力する、**Then** エラーメッセージが表示され、ログインできない

---

### User Story 2 - パスワードリセット (Priority: P2)

ユーザーが自分のパスワードを忘れた場合、メールを通じてパスワードをリセットできる。

**Why this priority**: ユーザーサポートのコストを削減し、ユーザーが自己解決できる重要な機能。ただし、基本的なログイン機能がないと意味がないため P2。

**Independent Test**: パスワードリセットリンクをクリックし、メール経由でリセットトークンを受け取り、新しいパスワードを設定して、そのパスワードでログインできることを確認。

**Acceptance Scenarios**:

1. **Given** ログイン画面にいる、**When** "パスワードを忘れた"リンクをクリックし、登録済みメールアドレスを入力する、**Then** パスワードリセット用のリンクがメールで送信される
2. **Given** リセット用メールを受信した、**When** メール内のリンクをクリックして新しいパスワードを設定する、**Then** パスワードが更新され、新しいパスワードでログインできる
3. **Given** リセットリンクが発行されている、**When** 24時間以上経過したリンクにアクセスする、**Then** リンクが無効であることを示すメッセージが表示される

---

### User Story 3 - ロール別アクセス制御 (Priority: P3)

システム管理者、一般ユーザーなど、異なる役割を持つユーザーが、それぞれに許可された機能のみにアクセスできる。

**Why this priority**: 基本的なログイン機能があれば最小限の価値は提供できるが、複数ユーザー種別がある場合に必要となる。セキュリティ強化と運用効率化に貢献。

**Independent Test**: 管理者ロールでログインして管理画面にアクセスできること、一般ユーザーロールでログインして管理画面にアクセスできないことを確認。

**Acceptance Scenarios**:

1. **Given** 管理者ロールのユーザーとしてログインしている、**When** 管理者専用画面にアクセスする、**Then** 画面が表示され、ユーザー管理機能が利用できる
2. **Given** user.edit 権限を持つユーザーとしてログインしている、**When** 他のユーザーの編集機能を実行する、**Then** 編集が許可され正常に完了する
3. **Given** user.edit 権限を持たない一般ユーザーロールでログインしている、**When** 他のユーザーの編集機能にアクセスする、**Then** アクセス拒否メッセージが表示され、機能は実行できない
4. **Given** 一般ユーザーロールでログインしている、**When** 管理者専用画面のURLに直接アクセスする、**Then** アクセス拒否メッセージが表示され、画面は表示されない
5. **Given** ログインしていない状態で、**When** 認証が必要な画面にアクセスする、**Then** ログイン画面にリダイレクトされる

---

### User Story 4 - セッション管理とセキュリティ (Priority: P1)

ユーザーのログインセッションが適切に管理され、一定時間操作がない場合は自動的にログアウトされる。

**Why this priority**: セキュリティの基本要件であり、不正アクセスを防ぐために必須。基本的なログイン機能と同時に実装すべき。

**Independent Test**: ログイン後、一定時間（30分）操作せずに放置し、その後操作を試みた際に再ログインが要求されることを確認。

**Acceptance Scenarios**:

1. **Given** ログイン済みである、**When** 30分間操作をしない、**Then** 次の操作時にセッションタイムアウトのメッセージが表示され、ログイン画面に遷移する
2. **Given** ログイン済みである、**When** 別のブラウザまたはデバイスで同じアカウントでログインする、**Then** すべてのセッションが継続され、複数デバイスから同時にアクセスできる
3. **Given** ログイン中である、**When** ブラウザを閉じて再度開く、**Then** ログイン時に「ログイン状態を保持」を選択していた場合は自動的にログイン状態が維持され、選択していない場合は再ログインが必要となる

---

### Edge Cases

- ユーザーが複数回連続してログインに失敗した場合、FR-006に従ってアカウントが一時的にロックされ、15分後に自動解除される
- パスワードリセット中に複数回リセットリクエストを送信した場合、最新のトークンのみが有効となり、以前のトークンはすべて無効化される
- パスワードリセットメールの送信が失敗した場合、ユーザーには「メールを送信しました。届かない場合は迷惑メールフォルダを確認するか、サポートにお問い合わせください」と表示し、内部的にエラーログに記録する
- ユーザーがメールアドレスを変更した場合、新しいメールアドレスに確認メールが送信され、確認が完了するまで変更は反映されない
- ネットワーク障害や外部認証サービスのダウン時、ログイン処理はタイムアウト（10秒）し、ユーザーに「現在ログインできません。しばらくしてから再度お試しください」というメッセージを表示する
- 同じメールアドレスで複数回アカウント作成を試みた場合、「このメールアドレスは既に登録されています」というエラーメッセージを表示し、登録を拒否する
- パスワード変更直後、セキュリティ上の理由から、変更を実行した現在のセッション以外のすべてのセッションを無効化する

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは新規ユーザーがメールアドレス、パスワード、名前を入力してアカウントを作成できなければならない
- **FR-002**: システムはメールアドレス形式の妥当性を検証しなければならない
- **FR-003**: システムはパスワード強度を検証しなければならない（最小8文字、少なくとも1つの数字と1つの大文字を含む）
- **FR-004**: システムはパスワードを安全にハッシュ化して保存しなければならない
- **FR-005**: ユーザーは登録済みのメールアドレスとパスワードでログインできなければならない
- **FR-006**: システムはログイン失敗回数を追跡し、5回以上失敗した場合にアカウントを15分間ロックしなければならない
- **FR-007**: ユーザーはログアウト機能を使用してセッションを終了できなければならない
- **FR-008**: システムは各ユーザーにロール（管理者、一般ユーザーなど）を割り当てられなければならない
- **FR-009**: システムは各画面・機能へのアクセス時にユーザーの権限を検証しなければならない。権限検証は機能単位の細かい粒度で行われる（例: ユーザー作成、ユーザー編集、ユーザー削除、レポート閲覧など）
- **FR-019**: システムは権限（Permission）を管理し、各ロールに複数の権限を割り当てられなければならない。権限は機能ごとに定義され（例: user.create, user.edit, user.delete, report.view）、ロールを通じてユーザーに付与される
- **FR-010**: ユーザーはパスワードリセット機能を通じてパスワードを再設定できなければならない
- **FR-011**: システムはパスワードリセット用の一時トークンを生成し、メールで送信しなければならない。メール送信が失敗した場合でも、ユーザーには成功メッセージを表示し、内部的にエラーログに記録する
- **FR-012**: パスワードリセットトークンは24時間で無効になり、一度使用されると再利用できなくなる必要がある
- **FR-013**: システムはユーザーセッションを管理し、30分間操作がない場合は自動的にセッションを無効化しなければならない
- **FR-014**: システムはログイン時に「ログイン状態を保持」オプションを提供し、選択された場合は30日間セッションを維持しなければならない
- **FR-015**: システムはすべての認証・認可関連のイベント（ログイン成功/失敗、パスワード変更、権限変更など）をログに記録しなければならない
- **FR-020**: 監査ログは90日間保存され、その後自動的に削除されなければならない
- **FR-016**: 新規アカウント作成時にメール確認を送信し、ユーザーがメールアドレスを確認するまでアカウントを「未確認」状態にしなければならない
- **FR-017**: 未確認状態のアカウントでログインした場合、システムへのアクセスは許可するが、機能制限を適用し、画面上部に「メール確認が必要です」というバナーを常時表示しなければならない
- **FR-018**: 未確認状態のアカウントは、メール内の確認リンクをクリックすることでアクティブ状態に遷移し、すべての機能にアクセス可能となる

### Key Entities

- **User（ユーザー）**: システムを利用する個人。メールアドレス（ユニーク識別子）、ハッシュ化されたパスワード、名前、ロール、アカウント状態（アクティブ、ロック、未確認）、作成日時、最終ログイン日時を持つ。
- **Role（ロール）**: ユーザーに割り当てられる権限グループ。ロール名（例: ADMIN, USER, MODERATOR）と、そのロールが持つ機能単位の権限セットを定義する。各ロールは複数の権限（Permission）を保持し、権限は機能ごとに細かく定義される（例: user.create, user.edit, user.delete, user.view, report.view, report.export など）。
- **Permission（権限）**: 特定の機能に対するアクセス権を表す。権限名（例: user.create, report.view）と説明を持つ。ロールに紐付けられ、ユーザーがその機能を実行できるかを判定する。
- **Session（セッション）**: ユーザーのログイン状態を表す。ユーザーID、セッショントークン、作成日時、有効期限、最終アクセス日時を持つ。
- **PasswordResetToken（パスワードリセットトークン）**: パスワードリセット要求時に生成される一時的な認証情報。ユーザーID、トークン文字列、有効期限、使用済みフラグを持つ。
- **AuditLog（監査ログ）**: 認証・認可関連のイベント記録。ユーザーID、イベントタイプ（ログイン成功、ログイン失敗、パスワード変更など）、IPアドレス、タイムスタンプ、詳細情報を持つ。ログは90日間保存され、その後自動的に削除される。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーはアカウント作成からログイン完了まで2分以内に完了できる
- **SC-002**: ログイン処理は通常時1秒以内に完了する
- **SC-003**: システムは100人の同時ログインユーザーを性能劣化なく処理できる
- **SC-004**: パスワードリセット要求からメール受信まで5分以内に完了する
- **SC-005**: ログイン失敗率が5%以下である（ユーザビリティの指標）
- **SC-006**: 不正アクセス試行（複数回のログイン失敗）が適切にブロックされ、監査ログに記録される
- **SC-007**: 権限のないユーザーが制限された機能にアクセスしようとした場合、100%の確率でブロックされる
- **SC-008**: セッションタイムアウトが設定された時間（30分）の±1分以内に正確に動作する
- **SC-009**: 「ログイン状態を保持」機能を使用したユーザーの90%以上が再ログインせずにシステムを継続利用できる
- **SC-010**: システムは月間99.5%以上の可用性を維持し、計画外のダウンタイムは月間3.6時間以内に抑える

## Assumptions *(optional)*

- ユーザーは有効なメールアドレスを持っており、メールを受信できる環境にある
- システムはメール送信サービス（SMTP または外部メールAPI）にアクセスできる
- パスワードポリシーのデフォルト: 最小8文字、少なくとも1つの数字と1つの大文字を含む
- デフォルトのユーザーロールは「一般ユーザー」であり、管理者ロールは別途手動で割り当てられる
- セッション情報はサーバー側で管理される（クライアント側のみの認証は行わない）
- ログイン失敗時のアカウントロックは15分間とし、その後自動的に解除される
- 同一アカウントでの同時ログインは許可される（複数デバイス対応）

## Dependencies *(optional)*

- メール送信機能（パスワードリセット、アカウント確認メール用）
- セキュアなパスワードハッシュ化ライブラリ（実装時に選定）
- セッション管理機構（実装時に選定）
- 既存の Miometry Entry System のユーザーデータベーススキーマとの統合

## Out of Scope *(optional)*

- ソーシャルログイン（Google、Facebook等の外部認証プロバイダー連携）
- 多要素認証（2FA/MFA）
- シングルサインオン（SSO）
- OAuth2 / OpenID Connect プロバイダーとしての機能
- 生体認証（指紋、顔認証）
- パスワードレス認証
- ユーザープロファイル編集機能（名前、メールアドレス以外の情報）
- LDAP / Active Directory 連携
