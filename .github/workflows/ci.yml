name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: read
  packages: write
  pull-requests: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-format:
    name: Lint & Format Check
    if: github.event.action != 'labeled'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run lint and format checks in devcontainer
        uses: devcontainers/ci@8bf61b26e9c3a98f69cb6ce2f88d24ff59b785c6 # v0.3
        with:
          configFile: .devcontainer/devcontainer.json
          imageName: ghcr.io/${{ github.repository }}/devcontainer
          cacheFrom: ghcr.io/${{ github.repository }}/devcontainer
          push: never
          runCmd: |
            set -e
            cd backend && ./gradlew checkFormat detekt --no-daemon
            cd ../frontend && npm ci && npm run check:ci

  build-test-backend:
    name: Build & Test Backend
    if: github.event.action != 'labeled'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and test backend in devcontainer
        uses: devcontainers/ci@8bf61b26e9c3a98f69cb6ce2f88d24ff59b785c6 # v0.3
        with:
          configFile: .devcontainer/devcontainer.json
          imageName: ghcr.io/${{ github.repository }}/devcontainer
          cacheFrom: ghcr.io/${{ github.repository }}/devcontainer
          push: never
          runCmd: |
            set -e
            cd backend && ./gradlew build jacocoTestReport --no-daemon

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          name: backend-test-results
          path: backend/build/test-results/test/
          retention-days: 7

      - name: Upload JaCoCo report
        if: success()
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          name: jacoco-report
          path: backend/build/reports/jacoco/
          retention-days: 14

  build-test-frontend:
    name: Build & Test Frontend
    if: github.event.action != 'labeled'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and test frontend in devcontainer
        uses: devcontainers/ci@8bf61b26e9c3a98f69cb6ce2f88d24ff59b785c6 # v0.3
        with:
          configFile: .devcontainer/devcontainer.json
          imageName: ghcr.io/${{ github.repository }}/devcontainer
          cacheFrom: ghcr.io/${{ github.repository }}/devcontainer
          push: never
          runCmd: |
            set -e
            cd frontend && npm ci && npm run build && npm test -- --run --reporter=default --reporter=junit --outputFile=test-results/junit.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          name: frontend-test-results
          path: frontend/test-results/
          retention-days: 7

  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [build-test-backend]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download JaCoCo report
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: jacoco-report
          path: backend/build/reports/jacoco/

      - name: Post coverage comment on PR
        uses: madrapps/jacoco-report@7c362aca34caf958e7b1c03464bd8781db9f8da7 # v1.7.1
        with:
          paths: backend/build/reports/jacoco/test/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 80
          min-coverage-changed-files: 80
          title: "Backend Coverage Report"

  e2e-test:
    name: E2E Tests
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'e2e-test')
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run E2E tests in devcontainer
        uses: devcontainers/ci@8bf61b26e9c3a98f69cb6ce2f88d24ff59b785c6 # v0.3
        with:
          configFile: .devcontainer/devcontainer.json
          imageName: ghcr.io/${{ github.repository }}/devcontainer
          cacheFrom: ghcr.io/${{ github.repository }}/devcontainer
          push: never
          runCmd: |
            set -e
            # Install dependencies
            cd /workspaces/miometory/frontend && npm ci
            cd /workspaces/miometory/backend && ./gradlew build --no-daemon -x test

            # Start backend in background
            cd /workspaces/miometory/backend
            ./gradlew bootRun --args='--spring.profiles.active=dev' --no-daemon &
            BACKEND_PID=$!

            # Wait for backend to be ready (timeout after 120s)
            echo "Waiting for backend..."
            BACKEND_READY=false
            for i in $(seq 1 60); do
              if curl -sf http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "Backend is ready"
                BACKEND_READY=true
                break
              fi
              sleep 2
            done

            if [ "$BACKEND_READY" != "true" ]; then
              echo "ERROR: Backend failed to start within 120 seconds"
              kill $BACKEND_PID 2>/dev/null || true
              exit 1
            fi

            # Start frontend in background
            cd /workspaces/miometory/frontend
            npm run dev &
            FRONTEND_PID=$!

            # Wait for frontend to be ready (timeout after 60s)
            echo "Waiting for frontend..."
            FRONTEND_READY=false
            for i in $(seq 1 30); do
              if curl -sf http://localhost:3000 > /dev/null 2>&1; then
                echo "Frontend is ready"
                FRONTEND_READY=true
                break
              fi
              sleep 2
            done

            if [ "$FRONTEND_READY" != "true" ]; then
              echo "ERROR: Frontend failed to start within 60 seconds"
              kill $BACKEND_PID $FRONTEND_PID 2>/dev/null || true
              exit 1
            fi

            # Install Playwright browsers with OS dependencies and run E2E
            npx playwright install --with-deps chromium
            CI=true npx playwright test

            # Cleanup
            kill $BACKEND_PID $FRONTEND_PID 2>/dev/null || true

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 14

      - name: Upload Playwright screenshots
        if: failure()
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          name: playwright-screenshots
          path: frontend/test-results/
          retention-days: 7

  build-devcontainer-cache:
    name: Build & Push Devcontainer Cache
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push devcontainer image
        uses: devcontainers/ci@8bf61b26e9c3a98f69cb6ce2f88d24ff59b785c6 # v0.3
        with:
          configFile: .devcontainer/devcontainer.json
          imageName: ghcr.io/${{ github.repository }}/devcontainer
          push: always
